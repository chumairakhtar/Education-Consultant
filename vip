import streamlit as st
import requests
import os
import random
from dotenv import load_dotenv

# ----------------------------
# ğŸ”‘ Load environment variables
# ----------------------------
load_dotenv()
API_KEY = os.getenv("AZURE_API_KEY")
ENDPOINT = os.getenv("AZURE_ENDPOINT")

# ----------------------------
# ğŸ’¡ Predefined health tips
# ----------------------------
HEALTH_TIPS = [
    "ğŸ’§ Drink at least 8 glasses of water daily.",
    "ğŸ¥¦ Eat more fruits and vegetables to strengthen your immune system.",
    "ğŸƒâ€â™‚ï¸ Stay active â€” even a 20-minute walk helps.",
    "ğŸ˜´ Get 7â€“8 hours of quality sleep every night.",
    "ğŸ§˜ Practice mindfulness or meditation for stress relief.",
    "ğŸš­ Avoid smoking and limit alcohol consumption.",
    "ğŸ’Š Never self-medicate â€” consult a doctor for severe symptoms.",
    "ğŸ§´ Wash your hands regularly to prevent infection.",
    "â˜€ï¸ Get some sunlight for vitamin D.",
    "ğŸª¥ Maintain good oral hygiene."
]

# ----------------------------
# ğŸ§  Function to call Azure model
# ----------------------------
def get_ai_response(user_message):
    headers = {
        "Content-Type": "application/json",
        "api-key": API_KEY
    }

    payload = {
        "messages": [
            {"role": "system", "content": "You are an AI health assistant that provides possible causes and lifestyle suggestions based on symptoms."},
            {"role": "user", "content": user_message}
        ],
        "max_tokens": 300
    }

    try:
        response = requests.post(ENDPOINT, headers=headers, json=payload)
        response.raise_for_status()
        result = response.json()
        return result["choices"][0]["message"]["content"]
    except Exception as e:
        return f"âš ï¸ Something went wrong: {str(e)}"

# ----------------------------
# ğŸ§¾ Initialize chat history
# ----------------------------
if "chat_history" not in st.session_state:
    st.session_state.chat_history = []

# ----------------------------
# ğŸ¨ Streamlit Interface
# ----------------------------
st.title("ğŸ¥ AI Health Symptom Checker + Awareness Bot")
st.write("Describe your symptoms below â€” AI will suggest possible causes and healthy habits.")

symptoms = st.text_area("ğŸ©º Enter your symptoms:")

# ğŸ§  Add severity slider
severity = st.slider("Rate your symptom severity (1 = mild, 10 = severe):", 1, 10, 5)

if st.button("Check Now"):
    if symptoms.strip():
        with st.spinner("Analyzing your symptoms..."):
            user_message = f"My symptoms: {symptoms}. Severity level: {severity}/10."
            reply = get_ai_response(user_message)

            # Save to chat history
            st.session_state.chat_history.append({"user": symptoms, "severity": severity, "ai": reply})

            # Display response
            st.markdown("### ğŸ§  Possible Analysis:")
            st.write(reply)

            # ğŸ©µ Add random health tip
            st.markdown("---")
            st.markdown("### ğŸ’¡ Health Tip of the Day:")
            st.success(random.choice(HEALTH_TIPS))

    else:
        st.warning("Please enter your symptoms before clicking.")

# ----------------------------
# ğŸ’¬ Display Chat History
# ----------------------------
if st.session_state.chat_history:
    st.markdown("---")
    st.markdown("### ğŸ—‚ï¸ Previous Chats")
    for chat in reversed(st.session_state.chat_history):
        st.markdown(f"**ğŸ§â€â™‚ï¸ You:** {chat['user']} (Severity: {chat['severity']}/10)")
        st.markdown(f"**ğŸ¤– AI:** {chat['ai']}")
        st.markdown("---")
